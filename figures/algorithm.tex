\begin{figure*}[!ph]
\centering
\small

\begin{flushleft}
\fbox{$\cgp \vdash T^\circ \rightsquigarrow C, T \Rightarrow T$}
\end{flushleft}

\vspace{-2ex}

\begin{mathpar}
\inferrule[\defrule{a-var-assum}]{~}{
    \cgp \vdash x \rightsquigarrow C, x \Rightarrow \Psi(x)
}

\inferrule[\defrule{a-const-assum}]{~}{
    \cgp \vdash x \rightsquigarrow C, x \Rightarrow \Gamma_G(x)
}

\inferrule[\defrule{a-var-def}]{
    (C_1, e : t) = \Psi(x) \and
    \overline{\upsilon_i} = \fresh{\svs{e} + \svs{t}} \\\\
    \overline{\upsilon'_i} = \SV(e, t) \and
    C_2 = C \cup \substvec{C_1}{\upsilon'_i}{\upsilon_i}
}{
    \cgp \vdash x \rightsquigarrow C_2, x^{\seq{\upsilon_i}} \Rightarrow \substvec{t}{\upsilon'_i}{\upsilon_i}
}

\inferrule[\defrule{a-const-def}]{
    (e : t) = \Gamma_G(x) \\\\
    \overline{\upsilon_i} = \fresh{\svs{e} + \svs{t}} \and
    \overline{\upsilon'_i} = \SV(e, t)
}{
    \cgp \vdash x \rightsquigarrow C, x^{\seq{\upsilon_i}} \Rightarrow \substvec{t}{\upsilon'_i}{\upsilon_i}
}

\inferrule[\defrule{a-univ}]{~}{
    \cgp \vdash U \rightsquigarrow C, U \Rightarrow \axiom{U}
}

\inferrule[\defrule{a-prod}]{
    \cgp \vdash t^\circ \rightsquigarrow C_1, t \Rightarrow^* U_1 \\\\
    C_1, \Gamma_G, \Psi(x:t) \vdash u^\circ \rightsquigarrow C_2, u \Rightarrow^* U_2
}{
    \cgp \vdash \prod{x}{t^\circ\!}{u^\circ} \rightsquigarrow C_2, \prod{x}{t}{u} \Rightarrow \rules{U_1}{U_2}
}

\inferrule[\defrule{a-abs}]{
    \cgp \vdash t^\circ \rightsquigarrow C_1, t \Rightarrow^* U \\\\
    C_1, \Gamma_G, \Psi(x:t) \vdash e^\circ \rightsquigarrow C_2, e \Rightarrow u
}{
    \cgp \vdash \abs{x}{t^\circ\!}{e^\circ} \rightsquigarrow C_2, \abs{x}{|t|}{e} \Rightarrow \prod{x}{t}{u}
}
\hfill
\inferrule[\defrule{a-app}]{
    \cgp \vdash e_1^\circ \rightsquigarrow C_1, e_1 \Rightarrow^* \prod{x}{t}{u} \\\\
    C_1, \Gamma_G, \Psi \vdash e_2^\circ \Leftarrow t \rightsquigarrow C_2, e_2
}{
    \cgp \vdash e_1^\circ ~ e_2^\circ \rightsquigarrow C_2, e_1 ~ e_2 \Rightarrow u[x \coloneqq e_2]
}

\inferrule[\defrule{a-let-in}]{
    \cgp \vdash t^\circ \rightsquigarrow C_1, t \Rightarrow^* U \\
    C_1, \Gamma_G, \Psi \vdash e_1^\circ \Leftarrow t \rightsquigarrow C_2, e_1 \\\\
    C_2, \Gamma_G, \Psi(C_2, x:t \coloneqq e_1) \vdash e_2^\circ \rightsquigarrow C_3, e_2 \Rightarrow u
}{
    \cgp \vdash \letin{x}{t^\circ}{e_1^\circ}{e_2^\circ} \rightsquigarrow C_3, \letin{x}{|t|}{e_1}{e_2} \Rightarrow u[x \coloneqq e_1]
}

\inferrule[\defrule{a-ind}]{
    \upsilon = \fresh{1}
}{
    \cgp \vdash I \rightsquigarrow C, I^\upsilon \Rightarrow \indtype{\Sigma}{I}
}

\inferrule[\defrule{a-ind-star}]{
    \tau = \fresh{1} \and \mathcal{V}^* \coloneqq \mathcal{V}^* \cup \set{\tau}
}{
    \cgp \vdash I^* \rightsquigarrow C, I^\tau \Rightarrow \indtype{\Sigma}{I}
}

\inferrule[\defrule{a-constr}]{
    \upsilon = \fresh{1}
}{
    \cgp \vdash c \rightsquigarrow C, c \Rightarrow \constrtype{\Sigma}{c}{\upsilon}
}

\inferrule[\defrule{a-case}]{
    \cgp \vdash e^\circ \rightsquigarrow C_1, e \Rightarrow^* I_k^s ~ \overline{p} ~ \overline{a} \\
    C_1, \Gamma_G, \Psi \vdash P^\circ \rightsquigarrow C_2, P \Rightarrow t_p \\
    \prodctx{\any}{\prodctx{\Delta_k}{U_k}} = \indtype{\Sigma}{I_k} \\
    U = \decompose{t_p}{\norm{\Delta_k} + 1} \\
    \elim{U_k}{U}{I_k} \\
    \upsilon = \fresh{1} \\
    C_3 = \casesize{I_k^s}{\hat{\upsilon}} \\
    C_4 = t_p \preceq \motivetype{\Sigma}{\overline{p}}{U}{I_k^{\hat{\upsilon}}} \\
    C_5 = C_2 \cup C_3 \cup C_4 \\
    \textrm{For each $j$:} \\
    C_5, \Gamma_G, \Psi \vdash e^\circ_j \Leftarrow \branchtype{\Sigma}{\overline{p}}{c_j}{\upsilon}{P} \rightsquigarrow C_{6j}, e_j \\
    C_6 = \textstyle\bigcup_j C_{6j}
}{
    \cgp \vdash \caseof{P^\circ}{e^\circ}{c_j}{e_j^\circ} \rightsquigarrow C_6, \caseof{|P|}{e}{c_j}{e_j} \Rightarrow P ~ \overline{a} ~ e
}

\inferrule[\defrule{a-fix}]{
    \textrm{For each $k$:} \\
    \cgp \vdash t_k^\circ \rightsquigarrow \any, \any \Rightarrow \any \and
    \cgp \vdash \setrecstars{t_k^\circ}{n_k} \rightsquigarrow C_{1k}, t_k \Rightarrow^* U \\
    \prodctx{\Delta_k}{u_k} = \whnf{t_k} \and \prodctx{\Delta'_k}{u'_k} = \shift{\prodctx{\Delta_k}{u_k}} \and
    \textstyle\bigcup_k C_{1k}, \Gamma_G, \Psi\overline{(f_k : t_k)} \vdash e_k^\circ \Leftarrow \prodctx{\Delta'_k}{u'_k} \rightsquigarrow C_{2k}, e_k \\
    C_2 = \textstyle\bigcup_k C_{2k} \cup u_k \preceq u'_k \and
    C_3 = \RecCheckLoop{C_2}{\overline{\getrecvar{t_k}{n_k}}}{\overline{t_k}}{\overline{e_k}}
}{
    \cgp \vdash \fix{\seq{n_k}, m}{f_k}{t_k^\circ}{e_k^\circ} \rightsquigarrow C_3, \fix{\seq{n_k}, m}{f_k}{|t_k|^*}{e_k} \Rightarrow t_m
}

\inferrule[\defrule{a-cofix}]{
    \textrm{For each $k$:} \\
    \cgp \vdash t_k^\circ \rightsquigarrow \any, \any \Rightarrow \any \and
    \cgp \vdash \setcorecstars{t_k^\circ} \rightsquigarrow C_{1k}, t_k \Rightarrow^* U \\
    \prodctx{\Delta_k}{u_k} = \whnf{t_k} \and \prodctx{\Delta'_k}{u'_k} = \shift{\prodctx{\Delta_k}{u_k}} \and
    \textstyle\bigcup_k C_{1k}, \Gamma_G, \Psi\overline{(f_k : t_k)} \vdash e_k^\circ \Leftarrow \prodctx{\Delta'_k}{u'_k} \rightsquigarrow C_{2k}, e_k \\
    C_2 = \textstyle\bigcup_k C_{2k} \cup \Delta'_k \preceq \Delta_k \and
    C_3 = \RecCheckLoop{C_2}{\Psi}{\overline{\getcorecvar{t_k}}}{\overline{t_k}}{\overline{e_k}}
}{
    \cgp \vdash \cofix{m}{f_k}{t_k^\circ}{e_k^\circ} \rightsquigarrow C_3, \cofix{m}{f_k}{|t_k|^*}{e_k} \Rightarrow t_m
}
\end{mathpar}
\caption{Size inference algorithm: Inference}
\label{fig:algorithm}
\end{figure*}
